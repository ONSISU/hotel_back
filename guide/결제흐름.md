# [호텔예약 - 결제흐름]

> 결제는 서버가 최종권한.<br/>
> 흐름) 클라이언트 → 서버 → Toss → 서버 → DB
---

1. ✅ 호텔 존재 체크

---

2. ✅해당 날짜 예약 가능 여부

---

3. ✅남은 객실 수 체크

---

4. ✅결제 데이터 레디스 임시저장(정합성 체크, 위변조 방지를 위해)

```dbn-psql
* 임시저장시 필요한 저장데이터*
reservation_id
own_hotel_id
amount
status = PENDING
expires_at (5~10분)
```

---

5. ✅프론트에서의 토스 결제

---

6. ✅프론트에서 PaymentKey 전달 받아 결제승인 API 진행 (출금 발생 시점)

> > https://api.tosspayments.com/v1/payments/confirm
---

7. ✅발생 후 임시 저장된 레디스 데이터로 결제 승인처리 진행

> 트랜잭션 처리 필수!!
---

8. ✅승인 이후 처리

```dbn-psql
[결제성공]
1. reservation.status = PAID
2. reservation 생성
3. payment 테이블 저장
4. 이메일 전송


[결제실패]
1. reservation.status = FAILED
```